#
# Install Kubernetes using Ansible and Kubesprary
#
# Installable offline without internet.  Inventory values have been overridden to use the local apt and docker repo
#

# ssh into the seba-control-repo virtual machine.  This will be the ansible control host.  Packages should have already been 
# extracted and repos setup.


# Modify seba-pod specific ansible/kubespray inventory and configuration
# Set 3 k8s hosts in hosts.ini, replace 10.64.1.X with yours.
cd ~/kubespray-2.7.0/inventory/
vi seba-pod/hosts.ini

# Verify ansible can reach 3 hosts
cd ~/kubespray-2.7.0/
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "whoami; uname -a" --become --become-user=root


# Ad-hoc commands for environment setup

# Copy needed files onto k8s (kube-node) hosts
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/att-seba-pod.yaml dest=~/"
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/onos.yaml dest=~/"
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/scripts dest=~/"
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/radius-netcfg.json dest=~/"
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-pod-ca/ca/ca.crt dest=~/seba-pod-ca.crt"
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/provisioning-yaml dest=~/"

# Setup docker log rotation
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-control-repo/logrotate-docker dest=/etc/logrotate.d/docker-container" --become --become-user=root

# OPTIONAL!! add /etc/hosts entries for control-repo host ip.  NOT NEEDED IF USING DNS.  Replace 10.64.1.X with your seba-control-repo IP
# ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "echo '10.64.1.169    repo.seba.local' >> /etc/hosts" --become --become-user=root

# set scripts to be executable
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "chmod 755 ~/scripts/*"

# Install POD CA cert.  Replace non-root-user with your local username
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "cp /home/non-root-user/seba-pod-ca.crt /usr/local/share/ca-certificates/; update-ca-certificates" --become --become-user=root


# Run the ansible kubespray kubernetes installation.  Takes about 12 minutes. 
cd ~/kubespray-2.7.0/
ansible-playbook -i inventory/seba-pod/hosts.ini --become --become-user=root cluster.yml


# Ansible commands to configure all 3 k8s hosts

# Verify k8s.  All 3 hosts must be able to lookup services
ansible -i inventory/seba-pod/hosts.ini kube-node -a "dig +short kubernetes.default.svc.cluster.local @10.233.0.3"


# Ad-hoc commands for environment setup

# Initialize helm repos
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm init --client-only --stable-repo-url http://repo.seba.local/charts/"
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm repo update"

# Allow not-root-user to run docker commands.  Replace with your user
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "usermod -aG docker non-root-user" --become --become-user=root
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "cat ~/scripts/bashrc >> ~/.bashrc"

# Reboot all 3.  Be sure you know what your doing
#ansible -i inventory/seba-pod/hosts.ini kube-node -a "reboot" --become --become-user=root


# From here helm is used to install seba/voltha on k8s nodes themselves, seba-node1 seba-node2 seba-node3.  See helm-seba-voltha-install.txt
