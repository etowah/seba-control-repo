#
# Control Repo host steps
#

# Assumes repo node is packaged up with needed software

wget https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz
copy helm 
install apache2
install nfs server..?
install docker-ce 17.03

sudo usermod -aG docker foundry



## Install seba-pod specific inventory and configuration
## Included in tarball
cd ~/kubespray-2.7.0/inventory/
tar -zxvf ~/seba-control-repo/seba-pod-kubespray-config.tgz
# modify 3 kube hosts in hosts.ini, replace 10.64.1.X with yours.
vi seba-pod/hosts.ini

## Run the install.  Takes about 5 minutes. 
cd ~/kubespray-2.7.0/
ansible-playbook -i inventory/seba-pod/hosts.ini --become --become-user=root cluster.yml

mkdir /var/www/html/repo
mkdir /var/www/html/oar

cd /var/www/html/repo/
# fill with helm charts
helm repo index --url http://10.64.1.148/repo/ .

cd /var/www/html/oar/
curl -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=org.opencord&a=olt-app&v=2.1.0-SNAPSHOT&e=oar' -o olt-app-2.1.0-SNAPSHOT.oar
curl -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=org.opencord&a=sadis-app&v=2.2.0-SNAPSHOT&e=oar' -o sadis-app-2.2.0-SNAPSHOT.oar
curl -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=org.opencord&a=dhcpl2relay&v=1.5.0-SNAPSHOT&e=oar' -o dhcpl2relay-1.5.0-SNAPSHOT.oar
curl -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=org.opencord&a=aaa&v=1.8.0-SNAPSHOT&e=oar' -o aaa-1.8.0-SNAPSHOT.oar
curl -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&g=org.opencord&a=kafka&v=1.0.0-SNAPSHOT&e=oar' -o kafka-1.0.0-SNAPSHOT.oar

need to fix nem-manitoring after index.yaml generated

Generate pod CA key
Generate pod docker-repo key

Install ca locally
sudo cp seba-pod-ca/ca/ca.crt /usr/local/share/ca-certificates/seba-pod-ca.crt
sudo update-ca-certificates 
sudo systemctl restart docker


Run Docker repo

cp ~/ /etc/systemd/system/docker-repo.service
mkdir -p /var/docker-persist/docker-registry/registry
mkdir -p /var/docker-persist/docker-registry/auth
mkdir -p /var/docker-persist/docker-registry/certs
cp ~/seba-pod-ca/issued/docker-repo.key /var/docker-persist/docker-registry/certs
cp ~/seba-pod-ca/issued/docker-repo.crt /var/docker-persist/docker-registry/certs
systemctl daemon-reload 
systemctl start docker-repo

