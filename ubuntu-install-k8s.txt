#
# Install Kubernetes using Ansible and Kubesprary
#
# Installable offline without internet.  Inventory values have been overridden to use the local apt and docker repo
#

# ssh into the seba-control-repo virtual machine.  This will be the ansible control host.  Packages should have already been 
# extracted and repos setup. TODO: convert ansible ad-hoc commands into custom seba playbooks



# Copy and modify seba-pod specific ansible/kubespray inventory and configuration
# Set 3 k8s hosts in hosts.ini, replace 10.242.11.X with yours.

cp -a ~/seba-control-repo/kubespray-inventory/seba-pod ~/kubespray-2.7.0/inventory/
cd ~/kubespray-2.7.0/inventory/
vi seba-pod/hosts.ini

# Verify ansible can reach 3 hosts
cd ~/kubespray-2.7.0/
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "whoami; uname -a" --become --become-user=root


##
## add ceph here
##


# Ad-hoc commands for environment pre-setup and verification

# Install POD CA cert.  Replace non-root-user with your local username
ansible -i inventory/seba-pod/hosts.ini kube-node -m copy -a "src=~/seba-pod-ca/ca/ca.crt dest=/usr/local/share/ca-certificates/seba-pod-ca.crt" --become --become-user=root
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "update-ca-certificates" --become --become-user=root

#
# TODO: Fix swapoff in kubespray ansible scripts.  Currently swap must be removed MANUALLY.  Edit /etc/fstab to get rid of.
#
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "swapoff -a" --become --become-user=root


#
# Run the ansible kubespray kubernetes installation.  Takes about 12 minutes. 
cd ~/kubespray-2.7.0/
ansible-playbook -i inventory/seba-pod/hosts.ini --become --become-user=root cluster.yml

# Verify k8s.  All 3 hosts must be able to lookup services
ansible -i inventory/seba-pod/hosts.ini kube-node -a "dig +short kubernetes.default.svc.cluster.local @10.233.0.3"



# Ad-hoc commands for environment post-setup and verification

# Initialize helm repos
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm init --client-only"
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm repo add onf https://charts.opencord.org/"
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm repo update"

# Verify helm
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm search voltha"

# Allow not-root-user to run docker commands.  Replace with your user
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "usermod -aG docker foundry" --become --become-user=root
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "cat ~/scripts/bashrc >> ~/.bashrc"

# From here helm is used to install seba/voltha on k8s nodes themselves.  See helm-seba-voltha-install.txt
