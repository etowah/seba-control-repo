#
# Simple quick kubespray 3 server k8s cluster setup
#

# Requires 1 host/vm as the control host and 3 hosts/vm as k8s hosts
# This install is run from the 1 control host


## Generate needed SSH keyed authentication
cd ~/
ssh-keygen -t rsa

## modify for 3 kube hosts 10.242.11.X
declare -a IPS=(10.242.11.1 10.242.11.2 10.242.11.3)

# non-root-user on control host and 3 k8s hosts must match!  Also non-root-user must have passwordless sudo access
for i in ${IPS[@]}; do cat ~/.ssh/id_rsa.pub | ssh non-root-user@$i 'mkdir -p ~/.ssh/; cat >> ~/.ssh/authorized_keys'; done


## Install current version of pip, needed to get current ansible
## get-pip.py to be included in tarball
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
sudo python ~/get-pip.py
sudo pip -V

## Install tagged version of kubespray 2.7.0
## kubespray tgz to be included in tarball
cd ~/
curl https://codeload.github.com/kubernetes-incubator/kubespray/tar.gz/v2.7.0 -o kubespray-v2.7.0.tgz
tar -zxvf ~/kubespray-v2.7.0.tgz

## Install kubespray requirements.  gets ansible and installs in /usr/local
cd ~/kubespray-2.7.0/
sudo pip install -r requirements.txt


## Clone seba-control-repo.  needed for prebuilt ansible inventory seba-pod template
cd ~/
git clone https://github.com/etowah/seba-control-repo.git

## Install seba-pod specific inventory and configuration.  
cp -a ~/seba-control-repo/kubespray-inventory/seba-pod ~/kubespray-2.7.0/inventory/
## Alternatively you can create your own inventory configuration by coping the sample directory ~/kubespray-2.7.0/inventory/sample 
# cp -a ~/kubespray-2.7.0/inventory/sample ~/kubespray-2.7.0/inventory/seba-pod

# edit hosts.ini, replace 10.242.11.X with yours.
vi ~/kubespray-2.7.0/inventory/seba-pod/hosts.ini

  # example ip entries to change
  seba-node1 	 ansible_host=10.242.11.1 ip=10.242.11.1
  seba-node2 	 ansible_host=10.242.11.2 ip=10.242.11.2
  seba-node3 	 ansible_host=10.242.11.3 ip=10.242.11.3

# edit all.yml config file, remove reference to local helm charts stable repo (unless you plan on running a local charts repo)
# this allows the internet default stable charts repo to be used
vi ~/kubespray-2.7.0/inventory/seba-pod/group_vars/all/all.yml

  # delete this line:
  helm_stable_repo_url: "http://repo.seba.local/charts/"


# Verify ansible can reach 3 hosts
cd ~/kubespray-2.7.0/
ansible -i inventory/seba-pod/hosts.ini kube-node -m shell -a "whoami; uname -a" --become --become-user=root

## Run the install.  Takes about 12 minutes. 
cd ~/kubespray-2.7.0/
ansible-playbook -i inventory/seba-pod/hosts.ini --become --become-user=root cluster.yml

## Verify k8s.  All 3 hosts must be able to lookup services
ansible -i inventory/seba-pod/hosts.ini kube-node -a "kubectl get pods --all-namespaces -o wide"
ansible -i inventory/seba-pod/hosts.ini kube-node -a "dig +short kubernetes.default.svc.cluster.local @10.233.0.3"


## Install helm client
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm init --client-only"

## Verify helm
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm repo list"
ansible -i inventory/seba-pod/hosts.ini kube-node -a "helm list"



